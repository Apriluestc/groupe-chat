# 聊天室中的离线消息处理

## 离线的群友怎么获取离线消息

- 最基本的方案：在现代群友不存储消息，离线的群友才存储，
这样就会带来问题，如果在线的群友因为网络问题导致消息推送异常，那么就会漏消息

- 优化方案：不管群友是否在线，都要先存储消息，在线的群友收到消息则直接删除，
离线的群友下次上线后再删除，这样相当于一条消息存储多份，消息冗余，对存储介质造成了很大浪费

- 二次优化：群消息实体存储一份，用户只冗余消息 ID，这个优化，对于消息投递，以及
删除的核心流程没有影响，实践为：
  - 在线用户投递消息实体，ack 消息 ID，
  - 离线用户先拉取消息 ID，再拉取消息实体，再 ack 消息 ID

- 终极方案：利用群消息的偏序，特性优雅的实现只存储存一份，这就意味着每个用户只需要记录最近一次收到的消息 ID，
而不用记录所有未收到的消息 ID 集合，每当收到在线消息 ack 时，只需要更新这个最近一次收到的消息 ID 即可，
对于在线群友收到群消息后，修改这个 last_ack_msgid，但是此方案的前提时需要 id 呈自增或者自增趋势
